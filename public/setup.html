<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Admin User</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-top: 0; }
    button {
      background: #000;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 20px;
    }
    button:hover { background: #333; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      display: none;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Setup Admin User</h1>

    <div class="info">
      <strong>This will create:</strong><br><br>
      <strong>Admin Account:</strong><br>
      Email: Admin<br>
      Password: Admin123<br><br>

      <strong>Reception Account:</strong><br>
      Email: reception@company.com<br>
      Password: reception123<br><br>

      <strong>CSO Account:</strong><br>
      Email: cso@company.com<br>
      Password: cso123
    </div>

    <button id="createBtn" onclick="createUsers()">Create All Users</button>

    <div id="result" class="result"></div>
  </div>

  <script>
    const { createClient } = supabase;

    const supabaseUrl = 'https://wrwoloqmvqovxmexifgf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indyd29sb3FtdnFvdnhtZXhpZmdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1Mjc5MjgsImV4cCI6MjA3NjEwMzkyOH0.VWLyGCv7v9f_9aZ9VBhsiev8724AWobyWh7xvv9sjBg';

    const client = createClient(supabaseUrl, supabaseKey);

    async function createUsers() {
      const btn = document.getElementById('createBtn');
      const result = document.getElementById('result');

      btn.disabled = true;
      result.style.display = 'none';
      result.innerHTML = 'Creating users...';
      result.className = 'result info';
      result.style.display = 'block';

      try {
        const users = [
          { email: 'Admin', password: 'Admin123', role: 'admin', name: 'System Administrator' },
          { email: 'reception@company.com', password: 'reception123', role: 'reception', name: 'Reception Desk' },
          { email: 'cso@company.com', password: 'cso123', role: 'cso', name: 'Chief Security Officer' }
        ];

        let messages = [];

        for (const user of users) {
          try {
            // Sign up the user
            const { data: authData, error: authError } = await client.auth.signUp({
              email: user.email,
              password: user.password,
              options: {
                data: {
                  full_name: user.name
                }
              }
            });

            if (authError) {
              if (authError.message.includes('already registered')) {
                messages.push(`✓ ${user.email} already exists`);

                // Try to sign in to get the user ID
                const { data: signInData, error: signInError } = await client.auth.signInWithPassword({
                  email: user.email,
                  password: user.password
                });

                if (!signInError && signInData.user) {
                  // Check if user record exists
                  const { data: existingUser } = await client
                    .from('users')
                    .select('id')
                    .eq('id', signInData.user.id)
                    .maybeSingle();

                  if (!existingUser) {
                    // Create user record
                    await client.from('users').insert({
                      id: signInData.user.id,
                      email: user.email,
                      role: user.role,
                      full_name: user.name,
                      is_active: true
                    });
                    messages.push(`✓ Role assigned to ${user.email}`);
                  }

                  await client.auth.signOut();
                }
                continue;
              }
              throw authError;
            }

            if (authData.user) {
              // Create user record in users table
              const { error: userError } = await client
                .from('users')
                .insert({
                  id: authData.user.id,
                  email: user.email,
                  role: user.role,
                  full_name: user.name,
                  is_active: true
                });

              if (userError && !userError.message.includes('duplicate')) {
                throw userError;
              }

              messages.push(`✓ Created ${user.email}`);
            }
          } catch (err) {
            messages.push(`✗ Error with ${user.email}: ${err.message}`);
          }
        }

        result.innerHTML = `
          <strong>Setup Complete!</strong><br><br>
          ${messages.join('<br>')}
          <br><br>
          <strong>You can now login with:</strong><br>
          Email: Admin<br>
          Password: Admin123
          <br><br>
          <a href="/" style="color: #000; font-weight: bold;">Go to Application →</a>
        `;
        result.className = 'result success';

      } catch (error) {
        result.innerHTML = `<strong>Error:</strong> ${error.message}`;
        result.className = 'result error';
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
